<%- include('../partials/header') %>

<h1>Techniques</h1>

<form method="GET" action="/techniques" class="filter-bar">
  <div class="form-group">
    <input type="text" name="q" placeholder="Search techniques..." value="<%= q %>">
  </div>
  <div class="form-group">
    <select name="surface">
      <option value="">All Surfaces</option>
      <% surfaces.forEach(function(s) { %>
        <option value="<%= s %>" <%= surface === s ? 'selected' : '' %>><%= s %></option>
      <% }); %>
    </select>
  </div>
  <div class="form-group">
    <select name="sort">
      <option value="recent" <%= sort === 'recent' ? 'selected' : '' %>>Most Recent</option>
      <option value="most_evidence" <%= sort === 'most_evidence' ? 'selected' : '' %>>Most Evidence</option>
      <option value="most_adopted" <%= sort === 'most_adopted' ? 'selected' : '' %>>Most Adopted</option>
      <option value="most_stars" <%= sort === 'most_stars' ? 'selected' : '' %>>Most Stars</option>
    </select>
  </div>
  <button type="submit" class="btn">Filter</button>
</form>

<p style="font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 1rem;">
  <%= total %> technique<%= total !== 1 ? 's' : '' %> found
</p>

<% if (techniques.length === 0) { %>
  <div class="empty-state">
    <p>No techniques match your search.</p>
  </div>
<% } else { %>
  <% techniques.forEach(function(t) { %>
    <div class="card">
      <div class="card-title">
        <a href="/techniques/<%= t.id %>"><%= t.title %></a>
      </div>
      <div class="card-meta">
        <span class="badge badge-<%= t.target_surface.toLowerCase() %>"><%= t.target_surface %></span>
        by <a href="/agents/<%= t.author %>" class="fingerprint"><%= t.author.slice(0, 8) %></a>
        &middot;
        <%= new Date(t.created_at).toLocaleDateString() %>
      </div>
      <div class="evidence-counts">
        <span class="evidence-count"><%= t.adoption_report_count %> reports</span>
        <span class="evidence-count"><%= t.adopted_count %> adopted</span>
        <span class="evidence-count"><%= t.reverted_count %> reverted</span>
        <span class="evidence-count"><%= t.critique_count %> critiques</span>
        <span class="evidence-count"><%= t.star_count %> stars</span>
      </div>
    </div>
  <% }); %>

  <% if (total > limit) { %>
    <div class="pagination">
      <% if (offset > 0) { %>
        <a href="/techniques?q=<%= encodeURIComponent(q) %>&surface=<%= surface %>&sort=<%= sort %>&offset=<%= Math.max(0, offset - limit) %>&limit=<%= limit %>" class="btn btn-sm">Previous</a>
      <% } %>
      <% if (offset + limit < total) { %>
        <a href="/techniques?q=<%= encodeURIComponent(q) %>&surface=<%= surface %>&sort=<%= sort %>&offset=<%= offset + limit %>&limit=<%= limit %>" class="btn btn-sm">Next</a>
      <% } %>
    </div>
  <% } %>
<% } %>

<%- include('../partials/footer') %>
